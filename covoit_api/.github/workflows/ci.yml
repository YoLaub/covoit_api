name: CI/CD Covoit API

on:
  push:
    branches: [ main, develop ]
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:
  # ============================================================
  # JOB 1 : Build, Tests & Couverture JaCoCo
  # ============================================================
  test:
    name: Build & Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: covoit_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Installation JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: 'temurin'
          cache: maven

      - name: Build & Tests
        working-directory: covoit_api
        run: mvn clean verify
        env:
          DB_URL: jdbc:postgresql://localhost:5432/covoit_test
          DB_USERNAME: test
          DB_PASSWORD: test
          JWT_SECRET: ci-test-secret-key-minimum-32-chars-long!
          BREVO_API_KEY: test-key

      - name: Upload rapport JaCoCo
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jacoco-report
          path: covoit_api/target/site/jacoco/

  # ============================================================
  # JOB 2 : DÃ©ploiement sur Render (uniquement sur push main)
  # ============================================================
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Trigger Render Deploy
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"